# 🔍 Диагностика чата с апостолом

## Добавлено подробное логирование

Теперь в коде добавлено детальное логирование на всех уровнях:

### 📱 Mobile App (ChatScreen.tsx)
- 🖱️ Нажатие кнопки отправки
- 🔥 Вызов функции sendMessage
- ✅/❌ Проверка условий (текст, апостол, загрузка, пользователь)
- 📨 Создание сообщения
- 🔄 Обновление состояния
- 🌐 Отправка запроса к API
- 📥 Получение ответа
- 🚨 Обработка ошибок

### 🌐 API Service (api.ts)
- 🌐 Вызов chatAPI.sendMessage
- 🔧 Режим работы (онлайн/офлайн)
- 📴/🌐 Обработка запросов
- 📡 Детали HTTP запроса
- 📥 Ответ от сервера
- ❌ Ошибки сети и API

### 🖥️ Backend API (route.ts)
- 🚀 Получение запроса
- 📦 Разбор тела запроса
- 👤 Поиск апостола в БД
- 🤖 Подготовка контекста для AI
- 🔄 Запрос к OpenAI
- 💾 Сохранение в БД
- 📤 Отправка ответа

### 🤖 OpenAI Integration (openai.ts)
- 🤖 Вызов generateApostleResponse
- 📝 Параметры запроса
- 🔑 Проверка API ключа
- 📨 Подготовка сообщений
- ✅ Ответ от OpenAI API
- 📊 Использование токенов

## 🚀 Как диагностировать

### 1. Запустите приложение с консолью:

**Backend:**
```bash
cd backend
npm run dev
```

**Mobile:**
```bash
cd mobile
npm start
```

### 2. Откройте DevTools в браузере или Expo Dev Tools

### 3. Попробуйте отправить сообщение и отследите логи:

**Ожидаемая последовательность логов:**

```
🖱️ Кнопка отправки нажата!
🖱️ inputText: [ваш текст]
🖱️ isLoading: false
🖱️ disabled: false

🔥 sendMessage вызвана
📝 inputText: [ваш текст]
👤 currentApostle: peter
⏳ isLoading: false
🆔 user?.id: test-user-123

✅ Все проверки прошли, начинаем отправку сообщения
📨 Создано пользовательское сообщение: {...}
🔄 Состояние обновлено: сообщение добавлено, input очищен, loading=true

🌐 chatAPI.sendMessage вызвана с параметрами: {...}
🔧 CONFIG.USE_OFFLINE_MODE: false
🌐 Отправляем запрос к серверу
📡 Делаем POST запрос к /chat
🔗 URL: http://localhost:3000/api/chat

[Backend]
🚀 Backend API /chat получил запрос
📦 Тело запроса: {...}
🔍 Параметры запроса: [детали]
👤 Найден апостол: Пётр Непоколебимый
🤖 generateApostleResponse вызвана
🔑 OpenAI API Key установлен: true
✅ Получен ответ от OpenAI API
📤 Отправляем ответ клиенту: {...}

[Mobile]
📥 Получен ответ от сервера: {...}
✅ Сообщение апостола добавлено в UI
🏁 Отправка завершена, loading=false
```

## 🔍 Частые проблемы:

### Кнопка не нажимается:
- Ищите лог `🖱️ Кнопка отправки нажата!`
- Если его нет - проблема в UI (disabled состояние)

### Функция sendMessage не вызывается:
- Ищите лог `🔥 sendMessage вызвана`
- Проверьте условия: текст, апостол, загрузка, пользователь

### Запрос не отправляется к серверу:
- Ищите лог `🌐 Отправляем запрос к серверу`
- Проверьте CONFIG.USE_OFFLINE_MODE

### Backend не получает запрос:
- Ищите лог `🚀 Backend API /chat получил запрос`
- Проверьте что backend запущен на :3000

### OpenAI не отвечает:
- Ищите лог `🔑 OpenAI API Key установлен: true`
- Проверьте валидность API ключа

### Ответ не возвращается в UI:
- Ищите лог `📥 Получен ответ от сервера`
- Проверьте нет ли ошибок парсинга

## 🛠️ Решения проблем

Теперь по логам вы сможете точно определить где застревает процесс и исправить проблему! 